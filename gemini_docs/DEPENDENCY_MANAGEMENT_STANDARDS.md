AMAIE Dependency Management Standards

  This document defines the standards for managing project dependencies within the AMAIE
  system. Consistent and reproducible dependency management is critical for ensuring
  stable development environments, reliable deployments, and preventing "works on my
  machine" issues.

  ---

  1. Core Principles

   * Reproducibility: Any developer or CI/CD pipeline should be able to set up an identical
     environment with the exact same dependencies.
   * Isolation: Project dependencies should be isolated from the system-wide Python
     installation and other projects to prevent conflicts.
   * Explicit Declaration: All direct and indirect dependencies should be clearly declared
     and managed.
   * Security: Regularly review and update dependencies to mitigate security
     vulnerabilities.
   * Efficiency: Streamline the process of adding, updating, and removing dependencies.

  ---

  2. Tooling

   * `pip`: The standard package installer for Python. Used for installing packages.
   * `pip-tools`: A set of command-line tools (pip-compile, pip-sync) that help manage
     Python dependencies. It allows you to specify top-level dependencies and automatically
     generates a fully pinned requirements.txt file, including all transitive dependencies.
   * `venv` (Python's built-in module): Used for creating lightweight virtual environments.

  ---

  3. Requirements Files

  AMAIE uses a multi-file approach for dependency management to separate core, development, and production dependencies.

   * `requirements.in`:
       * Purpose: Defines the direct, top-level dependencies for the core application. This file is human-editable.
       * Location: Project root.

   * `requirements-dev.in`:
       * Purpose: Defines dependencies needed only for development and testing (e.g., `pytest`, `black`, `mypy`).
       * Location: Project root.
       * Constraint: It uses `-c requirements.txt` to ensure its dependencies are compatible with the core application's pinned versions.

   * `requirements-prod.in`:
       * Purpose: Defines dependencies needed only for production deployments (e.g., `uvicorn`, `fastapi`).
       * Location: Project root.
       * Constraint: It uses `-c requirements.txt` to ensure its dependencies are compatible with the core application's pinned versions.

   * `requirements.txt`, `requirements-dev.txt`, `requirements-prod.txt`:
       * Purpose: These files contain the fully pinned lists of all direct and transitive dependencies. They are machine-generated by `pip-compile` and should **not** be manually edited.
       * Location: Project root.

  ---

  4. Dependency Management Workflow

   * **Step 1: Edit the `.in` files**
     * To add or remove a core dependency, edit `requirements.in`.
     * To add or remove a development dependency, edit `requirements-dev.in`.
     * To add or remove a production dependency, edit `requirements-prod.in`.

   * **Step 2: Compile the requirements files**
     The compilation must happen in a specific order. First, compile the base `requirements.in`, and then compile the `dev` and `prod` files, which use the newly generated `requirements.txt` as a constraint.

     ```bash
     # 1. Compile the base requirements
     pip-compile requirements.in -o requirements.txt

     # 2. Compile the development requirements
     pip-compile requirements-dev.in -o requirements-dev.txt

     # 3. Compile the production requirements
     pip-compile requirements-prod.in -o requirements-prod.txt
     ```

   * **Step 3: Install/Sync the dependencies**
     Use `pip-sync` to update your virtual environment to match the exact contents of the generated files.

     ```bash
     # For a development environment
     pip-sync requirements.txt requirements-dev.txt

     # For a production environment
     pip-sync requirements.txt requirements-prod.txt
     ```

  ---

  5. Virtual Environments

   * Mandatory: All development and deployment must occur within a dedicated Python virtual
     environment. This prevents conflicts between projects and isolates dependencies.
   * Creation:
   1     python3 -m venv venv
   * Activation:
   1     source venv/bin/activate
   * Installation: Once activated, install dependencies using `pip-sync`.

  ---

  6. Dependency Update Process

  Regularly updating dependencies is crucial for security, performance, and accessing new
  features.

   1. Review Changes: Before updating, review the changelogs of major dependencies for
      breaking changes or important notes.
   2. Update `.in` files: Increment version specifiers in the appropriate `.in` files (e.g.,
      `torch>=2.0.0` to `torch>=2.3.0`) or add/remove direct dependencies.
   3. Re-compile: Run the `pip-compile` commands in the correct order as described in section 4.
   4. Install and Test: Use `pip-sync` to update your installed packages and run the full test suite to ensure no regressions.
   5. Commit: Commit the updated `.in` and `.txt` files to version control.

  ---

  7. Continuous Integration (CI)

   * Automated Checks: The CI pipeline should automatically create a fresh virtual
     environment, install dependencies from the appropriate `.txt` files, and
      run all tests. This verifies reproducibility and catches dependency-related issues
     early.
   * Dependency Vulnerability Scanning: Integrate tools (e.g., `pip-audit`, Snyk, Dependabot)
     into the CI pipeline to scan for known security vulnerabilities in dependencies.

  ---

